---
applyTo: "app/tests/**/*.php"
---

# Test Instructions

## Test Structure

Tests are organized under `app/tests/`:
- `unit/Library/Jkl/` - Tests for custom library classes
- `unit/Models/` - Tests for Model classes
- `unit/ViewHelpers/` - Tests for view helpers
- `bootstrap.php` - Test bootstrap (autoloading, environment setup)
- `phpunit.xml` - PHPUnit configuration

## PHPUnit Standards

- **Version**: PHPUnit 9.6
- **Namespace**: Tests do NOT use namespaces (legacy codebase)
- **Base class**: Extend `PHPUnit\Framework\TestCase`
- **Type hints**: Use strict types (`void`, `string`, etc.) in test methods
- **Method naming**: `test*` prefix (e.g., `testGetUrlMethodExists`)

## Test Patterns

### Testing Container Methods (without Database)

Use reflection to verify method existence and signatures:

```php
class Model_Album_ContainerTest extends TestCase
{
    public function testGetUrlMethodExists(): void
    {
        $reflectionClass = new ReflectionClass('Model_Album_Container');
        
        $this->assertTrue(
            $reflectionClass->hasMethod('getUrl'),
            'Album Container should have getUrl method'
        );
    }
    
    public function testGetUrlMethodSignature(): void
    {
        $reflectionClass = new ReflectionClass('Model_Album_Container');
        $method = $reflectionClass->getMethod('getUrl');
        
        $this->assertEquals(
            0,
            $method->getNumberOfRequiredParameters(),
            'getUrl() should not require parameters'
        );
    }
}
```

### Testing Library Classes

Mock dependencies and test logic in isolation:

```php
class Jkl_Tools_StringTest extends TestCase
{
    public function testToAsciiConvertsPolishCharacters(): void
    {
        $input = 'ąćęłńóśźż ĄĆĘŁŃÓŚŹŻ';
        $expected = 'acelnoszz ACELNOSZZ';
        
        $result = Jkl_Tools_String::toAscii($input);
        
        $this->assertEquals($expected, $result);
    }
    
    public function testSlugifyCreatesUrlFriendlyString(): void
    {
        $input = 'Test Album Title!';
        $expected = 'test-album-title';
        
        $result = Jkl_Tools_String::slugify($input);
        
        $this->assertEquals($expected, $result);
    }
}
```

### Testing View Helpers

Test with Zend Framework bootstrap loaded:

```php
class LoggedInTest extends TestCase
{
    private $helper;
    
    protected function setUp(): void
    {
        // Bootstrap loaded via tests/bootstrap.php
        $this->helper = new Zend_View_Helper_LoggedIn();
    }
    
    public function testReturnsStringOutput(): void
    {
        $result = $this->helper->loggedIn();
        
        $this->assertIsString($result);
    }
}
```

## Running Tests

```bash
# Run all tests
cd app && ./vendor/bin/phpunit -c tests/phpunit.xml

# Run specific test file
cd app && ./vendor/bin/phpunit tests/unit/Library/Jkl/DbTest.php

# Run with coverage
cd app && ./vendor/bin/phpunit -c tests/phpunit.xml --coverage-html tests/coverage
```

## Test Data

- **Smoke tests** use deterministic fixtures from `database/tests/02-test-fixtures.sql`
- **Unit tests** should mock database access, not use real database
- Test images generated by `app/tools/generate-test-images.php`

## Coverage Expectations

- **Library classes** (`Jkl_*`): High coverage expected
- **View helpers**: Test public methods
- **Models**: Test Container business logic (no database); Api methods tested via smoke tests
- **Controllers**: Tested via smoke tests, not unit tests

## Key Rules

1. **No database in unit tests**: Mock all database access
2. **Use ReflectionClass**: For testing method signatures without dependencies
3. **Descriptive test names**: `testGetUrlMethodExists`, not `testMethod1`
4. **One assertion focus per test**: Each test should verify one specific behavior
5. **Type hints on test methods**: Use `: void` return type
6. **Setup/teardown**: Use `setUp()` and `tearDown()` for test initialization
7. **Assertions messages**: Provide helpful failure messages as third parameter
