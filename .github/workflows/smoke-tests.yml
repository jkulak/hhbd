name: Smoke Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  smoke-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose services
        run: |
          docker compose up -d --build
          echo "Waiting for services to start..."

      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database..."
          timeout 60 bash -c 'until docker compose exec -T db mysqladmin ping -h localhost -u root -proot_password --silent; do sleep 2; done'
          echo "Database is ready!"

      - name: Import test database
        run: |
          echo "Importing database..."
          docker compose exec -T db mysql -uhhbd -phhbd_password hhbd < database/_backup/2016-06-30-hhbd.sql
          echo "Database imported!"

      - name: Wait for PHP-FPM to be healthy
        run: |
          echo "Waiting for PHP-FPM..."
          timeout 60 bash -c 'until docker compose exec -T app php-fpm-healthcheck 2>/dev/null; do sleep 2; done'
          echo "PHP-FPM is ready!"

      - name: Run smoke tests
        run: |
          ./tests/smoke-test.sh http://localhost:8080

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
