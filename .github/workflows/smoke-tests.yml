name: Smoke Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    env:
      COMPOSE_PROJECT_NAME: hhbd

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build app image with cache (builder target)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile-php
          target: builder
          tags: |
            ${{ env.COMPOSE_PROJECT_NAME }}-app:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build nginx image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile-nginx
          tags: |
            ${{ env.COMPOSE_PROJECT_NAME }}-nginx:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start Docker Compose services
        run: |
          # compose.ci.yaml overrides to use 'builder' stage which includes GD for test image generation
          docker compose -f compose.yaml -f compose.ci.yaml up -d
          echo "Waiting for services to start..."

      - name: Install Composer dependencies in app container
        run: |
          # Bind mount hides image-installed vendor, so install deps inside the running container
          docker compose exec -T app composer install --no-interaction --prefer-dist --no-progress
          echo "Composer dependencies installed!"

      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database..."
          timeout 60 bash -c 'until docker compose exec -T db mysqladmin ping -h localhost -u root -proot_password --silent; do sleep 2; done'
          echo "Database is ready!"

      - name: Generate test images
        run: |
          echo "Generating test cover images..."
          docker compose exec -T app php /var/www/html/app/tools/generate-test-images.php
          echo "ðŸ–¼ï¸ Test images generated!"

      - name: Wait for PHP-FPM to be healthy
        run: |
          echo "Waiting for PHP-FPM..."
          timeout 60 bash -c 'until docker compose exec -T app php-fpm-healthcheck 2>/dev/null; do sleep 2; done'
          echo "PHP-FPM is ready!"

      - name: Verify APPLICATION_ENV
        run: |
          echo "=== Checking APPLICATION_ENV ==="
          docker compose exec -T app bash -c 'echo "Shell: APPLICATION_ENV=$APPLICATION_ENV"'
          docker compose exec -T app php -r 'echo "PHP: APPLICATION_ENV=" . getenv("APPLICATION_ENV") . "\n";'

      - name: Run smoke tests
        run: |
          bash ./tests/smoke-test.sh http://localhost:8080

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs --tail=100
          echo "\n=== PHP error logs (app) ==="
          docker compose exec -T app sh -lc 'for f in /var/log/php-errors.log /var/log/hhbd-website/*.log; do [ -f "$f" ] && echo "--- $f ---" && tail -n 200 "$f"; done || true'

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
