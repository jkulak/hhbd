# Test Database Fixtures

This directory contains database initialization files organized by context.

## Directory Structure

```
database/
├── tests/
│   ├── 01-schema.sql       # Schema only (no data)
│   └── 02-test-fixtures.sql # Deterministic test data
├── dev/
│   └── init.sql            # Production-like data for local dev
└── README.md
```

## Files

| Directory | File | Description | Usage |
|-----------|------|-------------|-------|
| `tests/` | `01-schema.sql` | Database schema (structure only, no data) | CI smoke tests, automated testing |
| `tests/` | `02-test-fixtures.sql` | Test data with deterministic IDs for smoke tests | CI smoke tests, automated testing |
| `dev/` | `init.sql` | Production-like data for local development | Local dev (via compose.override.yaml) |

## Initialization Behavior

### Local Development

```bash
docker compose up -d
# Imports: database/dev/init.sql (production-like data)
```

### CI / Testing

```bash
docker compose -f compose.yaml -f compose.ci.yaml up -d
# Imports: database/tests/01-schema.sql + database/tests/02-test-fixtures.sql
```

### Manual Import

```bash
# Import test schema and fixtures
docker compose exec -T db mysql -uhhbd -phhbd_password hhbd < database/tests/01-schema.sql
docker compose exec -T db mysql -uhhbd -phhbd_password hhbd < database/tests/02-test-fixtures.sql

# Import dev data
docker compose exec -T db mysql -uhhbd -phhbd_password hhbd < database/dev/init.sql

# Generate test images
docker compose exec app php app/tools/generate-test-images.php
```

### Reset Database (Fresh Import)

```bash
# Delete volume and restart (forces re-import from mounted directory)
docker compose down -v
docker compose up -d
```

## Local Development Setup

### Option 1: Quick Start with Test Data

For a fresh dev environment with small, deterministic test data:

```bash
# Clean up any existing data
docker compose down -v

# Start services with test data
docker compose -f compose.yaml -f compose.ci.yaml up -d

# Verify
docker compose logs app | grep "ready"
```

This imports `database/tests/01-schema.sql` + `database/tests/02-test-fixtures.sql` — sufficient for feature development and testing.

### Option 2: Production-Like Data

For development with realistic data volume and content:

1. **Obtain a database dump** from production or a backup
   - Request from team lead or deployment logs
   - Or use a recent backup if available

2. **Place it in the right location:**

   ```bash
   # Copy your dump to database/dev/init.sql
   cp /path/to/production-backup.sql database/dev/init.sql
   ```

3. **Start services with dev data:**

   ```bash
   # Clean up
   docker compose down -v

   # Start (will import init.sql)
   docker compose up -d
   ```

4. **Verify:**

   ```bash
   docker compose exec db mysql -uhhbd -phhbd_password hhbd -e "SELECT COUNT(*) FROM artists;"
   ```

**Important**: `database/dev/init.sql` is **git-ignored** and contains sensitive data. Never commit it.

## Test Data Contents

### Database Records

| Table | Records | Notes |
|-------|---------|-------|
| artists | 51 | Including Pezet, Eldo, Mes (ID 35), etc. |
| albums | 50 | Including "Jestem Hip Hopem", Superextra (ID 535) |
| songs | 31 | Including Pogoda (ID 7329) with features |
| labels | 15 | Including Alkopoligamia (ID 58), Asfalt |
| news | 6 | Including ID 1877 (Onar article) |
| artists_photos | 30 | Linked to main artists |
| hhb_users | 10 | Test users for ratings/comments |
| ratings | 100 | For Top10 rankings |
| ratings_avg | 50 | Average ratings for albums |
| searches | 15 | Popular search terms |

### Test Images

Generated by `app/tools/generate-test-images.php`:

| Type | Count | Directory | Filename Pattern |
|------|-------|-----------|------------------|
| Album covers | 50 | `content/a/` | `test-cover-001.jpg` to `test-cover-050.jpg` |
| Artist photos | 30 | `content/p/` | `test-artist-001.jpg` to `test-artist-030.jpg` |
| Label logos | 15 | `content/l/` | `test-label-001.jpg` to `test-label-015.jpg` |

**Total:** 95 placeholder images (100x100px, ~1.5KB each)

## Smoke Test Requirements

The test fixtures include specific records required by smoke tests:

### Required IDs

| Entity | ID | Content |
|--------|-----|---------|
| Artist | 35 | Mes (Piotr  Szmidt) |
| Album | 535 | Superextra (by Wdowa, label Alkopoligamia) |
| Song | 7329 | Pogoda (features Dj Technik, Beatmo) |
| Label | 58 | Alkopoligamia |
| News | 1877 | ONAR article with "Onar wraca z nowym singlem" |

### Required Content

- Homepage: Contains "Pezet"
- Album list: Contains "Jestem Hip Hopem"
- Premieres: Contains "Stasiak"
- Artist list: Contains "Eldo"
- Label list: Contains "Asfalt"
- Search "tede": Returns "Mefistotedes" and "MercTedes"
- Top10 page: 70+ list items, 40+ thumbnails

## CI/CD Usage

GitHub Actions workflow (`.github/workflows/smoke-tests.yml`) automatically:

1. Imports `database/tests/01-schema.sql`
2. Imports `database/tests/02-test-fixtures.sql`
3. Generates test images via `app/tools/generate-test-images.php`
4. Runs smoke tests

## Polish Characters

Test data includes Polish characters (ą, ę, ć, ź, ż, ó, ł, ś, ń) in:

- Artist names
- Album titles
- Song lyrics
- News content
- Photo descriptions

## Updating Test Data

To add more test data:

1. Edit `database/tests/02-test-fixtures.sql`
2. Maintain deterministic IDs for smoke test requirements
3. Update image references if needed
4. Test locally before pushing

## Production Data

**DO NOT** use test fixtures in production. Use `database/init.sql` or a production backup instead.
