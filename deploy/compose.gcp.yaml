#
# HHBD - Production Docker Compose for GCP Free Tier
#
# Optimized for e2-micro (1GB RAM) with memory limits and tuned settings
#
# Usage:
#   docker compose -f compose.gcp.yaml up -d
#   docker compose -f compose.gcp.yaml --profile tools up -d adminer
#

services:
  # PHP-FPM Application Server
  app:
    image: us-central1-docker.pkg.dev/hhbd-483111/hhbd/app:${APP_TAG:-latest}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      APPLICATION_ENV: production
      # Database
      DB_HOST: db
      DB_NAME: ${DB_NAME:-hhbd}
      DB_USER: ${DB_USER:-hhbd}
      DB_PASSWORD: ${DB_PASSWORD:-hhbd_password}
      # Feature flags
      SHOW_ADS: ${SHOW_ADS:-true}
      # PHP memory limit
      PHP_MEMORY_LIMIT: "128M"
    volumes:
      - /opt/hhbd/content:/var/www/html/content
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: [ "CMD", "php-fpm-healthcheck" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Nginx Web Server
  nginx:
    image: us-central1-docker.pkg.dev/hhbd-483111/hhbd/nginx:${NGINX_TAG:-latest}
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - /opt/hhbd/content:/var/www/html/content
    depends_on:
      app:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 64M

  # MariaDB Database
  db:
    image: mariadb:10.11.8
    restart: unless-stopped
    # Read-optimized for 23MB database (writes ~100/week)
    command: >
      --innodb-buffer-pool-size=96M --innodb-buffer-pool-dump-at-shutdown=1 --innodb-buffer-pool-load-at-startup=1 --max-connections=20 --innodb-log-file-size=16M --innodb-flush-log-at-trx-commit=2 --innodb-read-io-threads=4 --innodb-write-io-threads=1 --table-open-cache=400 --innodb-stats-on-metadata=0 --transaction-isolation=READ-COMMITTED --skip-name-resolve
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: ${DB_NAME:-hhbd}
      MYSQL_USER: ${DB_USER:-hhbd}
      MYSQL_PASSWORD: ${DB_PASSWORD:-hhbd_password}
    volumes:
      - db_data:/var/lib/mysql
    deploy:
      resources:
        limits:
          memory: 320M
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Adminer - Database Management (only start when needed)
  adminer:
    image: adminer:latest
    restart: unless-stopped
    ports:
      - "8082:8080"
    profiles:
      - tools
    environment:
      ADMINER_DEFAULT_SERVER: db
    depends_on:
      db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 64M

volumes:
  db_data:
